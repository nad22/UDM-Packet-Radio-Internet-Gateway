; ==================================================================================
; PlatformIO Project Configuration File for UDM Packet Radio Internet Gateway
; ==================================================================================
; 
; Build options: build flags, source filter
; Upload options: custom upload port, speed and extra flags
; Library options: dependencies, extra library storages
; Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html

[platformio]
description = UDM Packet Radio Internet Gateway - ESP32 Firmware
default_envs = esp32dev

[env:esp32dev]
platform = espressif32@^5.4.0
board = esp32dev  
framework = arduino

; Serial Monitor configuration
monitor_speed = 115200
monitor_port = COM*
monitor_filters = 
    esp32_exception_decoder
    time

; Upload configuration  
upload_port = COM*
upload_speed = 921600
upload_protocol = esptool

; Build configuration
build_flags = 
    -DCORE_DEBUG_LEVEL=0
    -DMQTT_MAX_PACKET_SIZE=1024
    -DMQTT_KEEPALIVE=300
    -O2

; Library dependencies with specific versions for stability
lib_deps = 
    adafruit/Adafruit GFX Library@^1.11.9
    adafruit/Adafruit SH110X@^2.1.10
    adafruit/Adafruit SSD1306@^2.5.7
    arduino-libraries/ArduinoMqttClient@^0.1.7
    bblanchon/ArduinoJson@^6.21.3

; Board configuration optimized for ESP32
board_build.mcu = esp32
board_build.f_cpu = 240000000L
board_build.f_flash = 80000000L
board_build.flash_mode = dio
board_build.partitions = default.csv

; Memory and performance optimization
board_build.arduino.memory_type = qio_qspi

; Extra scripts for build process
extra_scripts = 
    post:scripts/copy_ota.py

; Debug configuration
debug_tool = esp-prog
debug_init_break = tbreak setup

; Test configuration
test_framework = unity
test_build_src = true

; Check configuration
check_tool = clangtidy
check_flags = --enable-checker nullability.NullPassedToNonnull

; Environment-specific configurations
; ==================================

[env:esp32dev_debug]
extends = env:esp32dev
build_type = debug
build_flags = 
    ${env:esp32dev.build_flags}
    -DDEBUG_ESP_PORT=Serial
    -DDEBUG_ESP_CORE
    -DCORE_DEBUG_LEVEL=5
monitor_filters = 
    esp32_exception_decoder
    time
    log2file

[env:esp32dev_release]
extends = env:esp32dev
build_type = release
build_flags = 
    ${env:esp32dev.build_flags}
    -DCORE_DEBUG_LEVEL=1
    -DNDEBUG
    -Os
    ; Link Time Optimization for smaller binary
    -flto

[env:esp32dev_ota]
extends = env:esp32dev_release
upload_protocol = espota
upload_port = udmprig-client.local
upload_flags = --auth=udmprig